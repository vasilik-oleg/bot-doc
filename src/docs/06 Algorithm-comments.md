# 6. Примечания к алгоритму

На данной странице собраны подробные описания неочевидных моментов работы алгоритма робота.



## 6.1. Особенности использования торговых стаканов

В роботе для получения цен используются таблицы/потоки торговых стаканов по инструментам. Особенность работы со стаканами такова, что стакан не приходит с биржи в готовом виде. Чтобы минимизировать объём пересылаемой информации биржа присылает сначала снимок/слепок стакана по инструменту на какой-то момент времени, а потом приходят только обновления, сообщающие об изменениях в стакане. Робот НЕ строит стакан сразу по всем бумагам, стакан строится только по используемым в портфелях бумагам. Поэтому, для добавления новой бумаги в список бумаг, по которым строится стакан, необходимо переоткрыть поток с текущим слепком, а потом применять к нему обновления из потока инкрементальных обновлений. В момент получения потока со слепком, стакан в роботе временно перестает обновляться по всем используемым бумагам. Он начнет обновляться только после того как будет закрыт поток со слепком (это может занять некоторое время, зависящее от общего количества бумаг, приходящих в данном потоке, и размера стаканов) и начнут применяться инкрементальные обновления. Соответственно, в момент переоткрытия стакана вы можете наблюдать отсутствие цен по бумагам. Переоткрытие требуется в большинстве подключений, потому что стаканы по всем бумагам или полный лог заявок приходят, как правило, в одном потоке, т.е. нельзя получать данные по конкретным бумагам, получать вы всегда будете все данные, а использовать можете только для нужных бумаг.

Стакан в роботе может переоткрываться в следующих случаях:
создание нового портфеля;
добавление бумаги в портфель;
снятие флага Disabled с портфеля;
пропуски в номерах сообщений инкрементального потока обновлений стакана в UDP подключениях к биржам (чем больше у вас портфелей и бумаг, тем выше вероятность возникновения этих пропусков).
Т.е. произойдёт приостановка торговли по всем портфелям, использующим инструменты данной биржи. Это не является ошибочным поведением робота.



## 6.2. Использование приказа переместить заявку

На некоторых подключениях реализована отправка приказа переместить заявку (иногда эта команда также называется изменением заявки). Использование данного приказа позволяет сократить количество транзакций и увеличить отношение количества сделок к количеству транзакций, особенно при котировании, а так же увеличить время нахождения заявок в рынке. Так как особенности использования данной команды отличаются на разных рынках и типах подключений, то, в зависимости от подключения, данный приказ может применяться только для первой ноги портфеля или же для инструментов обеих ног. На данный момент отправка такой команды реализована для FIX-подключений фондового и валютного рынков Московской биржи, а так же TWIME-подключения срочного рынка Московской биржи.

Использование приказа переместить заявку для поддерживаемых подключений не является обязательным. Эта возможность может быть отключена при создании нового транзакционного подключения.



## 6.3. Правила перемещения Lim_Sell и Lim_Buy

Сигнальные цены Lim_Sell и Lim_Buy перемещаются только при прохождении сделок по Is first инструменту портфеля.

Правила перемещения сигнальных цен можно разделить на две части: произошла продажа по Is first бумаге и произошла покупка по Is first бумаге. Внутри каждой из этих частей алгоритм делится еще на две части: позиция портфеля до прохождения данной сделки была равна нулю и была не равна нулю.